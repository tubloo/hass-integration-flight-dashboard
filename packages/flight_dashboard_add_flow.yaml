input_text:
  fd_airline:
    name: FD Airline code (e.g. EK)
    icon: mdi:airplane
  fd_flight_number:
    name: FD Flight number (e.g. 236)
    icon: mdi:numeric
  fd_dep_airport:
    name: FD Departure airport (optional)
    icon: mdi:airplane-marker
  fd_travellers:
    name: FD Travellers (comma-separated)
    icon: mdi:account-multiple
  fd_notes:
    name: FD Notes
    icon: mdi:note-text

input_datetime:
  fd_flight_date:
    name: FD Flight date (local)
    has_date: true
    has_time: false
    icon: mdi:calendar

script:
  fd_preview_flight:
    alias: "Flight Dashboard: Preview flight"
    mode: single
    sequence:
      - variables:
          airline: "{{ states('input_text.fd_airline') | trim | upper }}"
          flight_number: "{{ states('input_text.fd_flight_number') | trim }}"
          date: "{{ states('input_datetime.fd_flight_date') }}"
          dep_airport: "{{ states('input_text.fd_dep_airport') | trim | upper }}"
          travellers_raw: "{{ states('input_text.fd_travellers') | trim }}"
          travellers: >-
            {% if not travellers_raw %} [] {% else %}
            {{ travellers_raw.split(',') | map('trim') | select('string') | list }}
            {% endif %}
          notes: "{{ states('input_text.fd_notes') | trim }}"
      - service: flight_dashboard.preview_flight
        data:
          airline: "{{ airline }}"
          flight_number: "{{ flight_number }}"
          date: "{{ date }}"
          dep_airport: "{{ dep_airport }}"
          travellers: "{{ travellers }}"
          notes: "{{ notes }}"

  fd_confirm_add:
    alias: "Flight Dashboard: Confirm add preview"
    mode: single
    sequence:
      - service: flight_dashboard.confirm_add
      - service: flight_dashboard.clear_preview
      - service: input_text.set_value
        data:
          entity_id:
            - input_text.fd_airline
            - input_text.fd_flight_number
            - input_text.fd_dep_airport
          value: ""

  fd_clear_preview:
    alias: "Flight Dashboard: Clear preview"
    mode: single
    sequence:
      - service: flight_dashboard.clear_preview

  fd_remove_selected_flight:
    alias: "Flight Dashboard: Remove selected flight"
    mode: single
    sequence:
      - variables:
          key: "{{ states('select.flight_dashboard_remove_flight') }}"
      - condition: template
        value_template: "{{ key not in ['unknown','unavailable','No flights',''] }}"
      - service: flight_dashboard.remove_manual_flight
        data:
          flight_key: "{{ key }}"

automation:
  - alias: "FD: Initialize add flight defaults"
    mode: single
    trigger:
      - platform: homeassistant
        event: start
    action:
      - service: input_text.set_value
        data:
          entity_id:
            - input_text.fd_airline
            - input_text.fd_flight_number
            - input_text.fd_dep_airport
          value: ""
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.fd_flight_date
          date: "{{ now().strftime('%Y-%m-%d') }}"
